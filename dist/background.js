(()=>{"use strict";const e=chrome.i18n.getUILanguage().split("-")[0],t=`https://www.diqt.net/${["ja","en"].includes(e)?e:"ja"}`,a="Basic "+btoa(unescape(encodeURIComponent("4fc8087015e6bd355e48d5fee254822e6baa679e:2e187d8f2e6d5a324458e75b8e1c376f603a1b7d")));chrome.action.onClicked.addListener((function(e){chrome.tabs.sendMessage(e.id,"Action").then((e=>{})).catch((e=>{}))})),chrome.tabs.onUpdated.addListener((function(e){chrome.tabs.sendMessage(e,"Updated").then((e=>{})).catch((e=>{}))})),chrome.runtime.onMessage.addListener((function(e){"openOptionsPage"===e.action&&chrome.runtime.openOptionsPage()})),chrome.runtime.onConnect.addListener((function(e){e.onMessage.addListener((function(n){switch(n.action){case"inspectCurrentUser":!async function(e){const n=await new Promise((e=>{fetch(`${t}/api/v1/extensions/users/current`,{method:"GET",mode:"cors",credentials:"include",dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:a}}).then((e=>e.json())).then((t=>{t.user?function(e){chrome.storage.local.set({diqtUserName:e.name}),chrome.storage.local.set({diqtUserIconUrl:e.icon_url}),chrome.storage.local.set({diqtUserPublicUid:e.public_uid}),chrome.storage.local.set({diqtPopupDisplayed:e.popup_displayed}),chrome.storage.local.set({diqtDictionaries:e.dictionaries})}(t.user):(chrome.storage.local.set({diqtUserName:""}),chrome.storage.local.set({diqtUserIconUrl:""}),chrome.storage.local.set({diqtUserPublicUid:""}),chrome.storage.local.set({diqtPopupDisplayed:""})),e(t)})).catch((t=>{console.log(t),e("error")}))}));e.postMessage({data:n})}(e);break;case"search":!async function(e,n){chrome.storage.local.get(["diqtSelectedDictionaryId"],(async function(s){let o=s.diqtSelectedDictionaryId;""!=o&&null!=o||(o=1,chrome.storage.local.set({diqtSelectedDictionaryId:`${o}`}));const r=await function(e,n){return new Promise((s=>{const o=`${t}/api/v1/extensions/dictionaries/${n}/search`,r={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({keyword:e}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:a}};fetch(o,r).then((e=>e.json())).then((e=>{s(e)})).catch((e=>{s(e)}))}))}(n,o);e.postMessage({data:r})}))}(e,n.keyword);break;case"createReview":!async function(e,n){const s=await function(e){return new Promise((n=>{const s=`${t}/api/v1/extensions/reviews`,o={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({quiz_id:e}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:a}};fetch(s,o).then((e=>e.json())).then((e=>{n(e)})).catch((e=>{console.log(e),n(e)}))}))}(n);e.postMessage({data:s})}(e,n.quizId);break;case"updateReview":!async function(e,n,s){const o=await function(e,n){return new Promise((s=>{const o=`${t}/api/v1/extensions/reviews/${e}`,r={method:"PATCH",mode:"cors",credentials:"include",body:JSON.stringify({interval_setting:n}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:a}};fetch(o,r).then((e=>e.json())).then((e=>{s(e)})).catch((e=>{console.log(e),s(e)}))}))}(n,s);e.postMessage({data:o})}(e,n.reviewId,n.settingNumber);break;case"destroyReview":!async function(e,n){const s=await function(e){return new Promise((n=>{fetch(`${t}/api/v1/extensions/reviews/${e}`,{method:"DELETE",mode:"cors",credentials:"include",dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:a}}).then((e=>e.json())).then((e=>{n(e)})).catch((e=>{console.log(e),n(e)}))}))}(n);e.postMessage({data:s})}(e,n.reviewId);break;case"googleTranslation":!async function(e,n,s,o){const r=await function(e,n,s){return new Promise((o=>{const r=`${t}/api/v1/extensions/langs/google_translate`,c={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({context:e,source_lang_number:n,target_lang_number:s}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:a}};fetch(r,c).then((e=>e.json())).then((e=>{o(e)})).catch((e=>{console.log(e),o(e)}))}))}(n,s,o);e.postMessage({data:r})}(e,n.keyword,n.sourceLangNumber,n.targetLangNumber);break;case"deeplTranslation":!async function(e,n,s,o){const r=await function(e,n,s){return new Promise((o=>{const r=`${t}/api/v1/extensions/langs/deepl_translate`,c={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({context:e,source_lang_number:n,target_lang_number:s}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:a}};fetch(r,c).then((e=>e.json())).then((e=>{o(e)})).catch((e=>{console.log(e),o(e)}))}))}(n,s,o);e.postMessage({data:r})}(e,n.keyword,n.sourceLangNumber,n.targetLangNumber);break;case"aiSearch":!async function(e,n,s,o,r,c,i){const d=Number(c)||0;if(1===i||"1"===i||d>=4)return void await async function(e,n,s,o,r,c){const i=`${t}/api/v1/extensions/langs/ai_search`,d={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({keyword:n,source_lang_number:s,target_lang_number:o,prompt_key:r,version:c,streaming:1}),headers:{"Content-Type":"application/json;charset=utf-8",authorization:a,Accept:"text/event-stream"}};let u;try{u=await fetch(i,d)}catch(t){return void e.postMessage({data:{status:500,message:t.message}})}const l=u.headers.get("content-type")||"";if(!u.ok||!l.includes("text/event-stream")){let t=null;try{t=await u.json()}catch(e){t={status:u.status,message:"AI search failed"}}return void e.postMessage({data:t})}if(!u.body)return void e.postMessage({data:{status:u.status,message:"AI search stream unavailable"}});const h=u.body.getReader(),p=new TextDecoder("utf-8");let m="",g=!1;try{for(;;){const{value:t,done:a}=await h.read();if(a)break;m+=p.decode(t,{stream:!0}),m=m.replace(/\r\n/g,"\n");const n=m.split("\n\n");m=n.pop(),n.forEach((t=>{t.split("\n").forEach((t=>{if(!t.startsWith("data:"))return;const a=t.replace(/^data:\s*/,"");if(!a)return;if("[DONE]"===a)return g=!0,void e.postMessage({data:{done:!0}});let n;try{n=JSON.parse(a)}catch(t){return void e.postMessage({data:{delta:a}})}n&&Object.prototype.hasOwnProperty.call(n,"delta")&&e.postMessage({data:{delta:n.delta}})}))}))}}catch(t){return void e.postMessage({data:{status:500,message:t.message}})}g||e.postMessage({data:{done:!0}})}(e,n,s,o,r,d);const u=await function(e,n,s,o,r){return new Promise((c=>{const i=`${t}/api/v1/extensions/langs/ai_search`,d={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({keyword:e,source_lang_number:n,target_lang_number:s,prompt_key:o,version:r}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:a}};fetch(i,d).then((e=>e.json())).then((e=>{c(e)})).catch((e=>{c(e)}))}))}(n,s,o,r,d);e.postMessage({data:u})}(e,n.keyword,n.sourceLangNumber,n.targetLangNumber,n.promptKey,n.version,n.streaming)}}))})),chrome.runtime.onMessage.addListener(((e,t,a)=>{if("playAudio"===e.action)return async function(e,t=1){return await async function(){console.log("createOffscreen"),await chrome.offscreen.hasDocument()?console.log("Offscreen document already exists"):await chrome.offscreen.createDocument({url:"offscreen.html",reasons:["AUDIO_PLAYBACK"],justification:"testing"})}(),new Promise(((a,n)=>{chrome.runtime.sendMessage({play:{source:e,volume:t}},(e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):a(e)}))}))}(e.url).then((e=>{a({success:!0,response:e})})).catch((e=>{a({success:!1,error:e.message})})),!0}))})();