(()=>{"use strict";const e=chrome.i18n.getUILanguage().split("-")[0],t=`https://www.diqt.net/${["ja","en"].includes(e)?e:"ja"}`,n="Basic "+btoa(unescape(encodeURIComponent("4fc8087015e6bd355e48d5fee254822e6baa679e:2e187d8f2e6d5a324458e75b8e1c376f603a1b7d")));chrome.action.onClicked.addListener((function(e){chrome.tabs.sendMessage(e.id,"Action").then((e=>{})).catch((e=>{}))})),chrome.tabs.onUpdated.addListener((function(e){chrome.tabs.sendMessage(e,"Updated").then((e=>{})).catch((e=>{}))})),chrome.runtime.onMessage.addListener((function(e){"openOptionsPage"===e.action&&chrome.runtime.openOptionsPage()})),chrome.runtime.onConnect.addListener((function(e){e.onMessage.addListener((function(o){switch(o.action){case"inspectCurrentUser":!async function(e){const o=await new Promise((e=>{fetch(`${t}/api/v1/extensions/users/current`,{method:"GET",mode:"cors",credentials:"include",dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:n}}).then((e=>e.json())).then((t=>{t.user?function(e){chrome.storage.local.set({diqtUserName:e.name}),chrome.storage.local.set({diqtUserIconUrl:e.icon_url}),chrome.storage.local.set({diqtUserPublicUid:e.public_uid}),chrome.storage.local.set({diqtPopupDisplayed:e.popup_displayed}),chrome.storage.local.set({diqtDictionaries:e.dictionaries})}(t.user):(chrome.storage.local.set({diqtUserName:""}),chrome.storage.local.set({diqtUserIconUrl:""}),chrome.storage.local.set({diqtUserPublicUid:""}),chrome.storage.local.set({diqtPopupDisplayed:""})),e(t)})).catch((t=>{console.log(t),e("error")}))}));e.postMessage({data:o})}(e);break;case"search":!async function(e,o){chrome.storage.local.get(["diqtSelectedDictionaryId"],(async function(a){let s=a.diqtSelectedDictionaryId;""!=s&&null!=s||(s=1,chrome.storage.local.set({diqtSelectedDictionaryId:`${s}`}));const c=await function(e,o){return new Promise((a=>{const s=`${t}/api/v1/extensions/dictionaries/${o}/search`,c={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({keyword:e}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:n}};fetch(s,c).then((e=>e.json())).then((e=>{a(e)})).catch((e=>{a(e)}))}))}(o,s);e.postMessage({data:c})}))}(e,o.keyword);break;case"createReview":!async function(e,o){const a=await function(e){return new Promise((o=>{const a=`${t}/api/v1/extensions/reviews`,s={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({quiz_id:e}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:n}};fetch(a,s).then((e=>e.json())).then((e=>{o(e)})).catch((e=>{console.log(e),o(e)}))}))}(o);e.postMessage({data:a})}(e,o.quizId);break;case"updateReview":!async function(e,o,a){const s=await function(e,o){return new Promise((a=>{const s=`${t}/api/v1/extensions/reviews/${e}`,c={method:"PATCH",mode:"cors",credentials:"include",body:JSON.stringify({interval_setting:o}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:n}};fetch(s,c).then((e=>e.json())).then((e=>{a(e)})).catch((e=>{console.log(e),a(e)}))}))}(o,a);e.postMessage({data:s})}(e,o.reviewId,o.settingNumber);break;case"destroyReview":!async function(e,o){const a=await function(e){return new Promise((o=>{fetch(`${t}/api/v1/extensions/reviews/${e}`,{method:"DELETE",mode:"cors",credentials:"include",dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:n}}).then((e=>e.json())).then((e=>{o(e)})).catch((e=>{console.log(e),o(e)}))}))}(o);e.postMessage({data:a})}(e,o.reviewId);break;case"googleTranslation":!async function(e,o,a,s){const c=await function(e,o,a){return new Promise((s=>{const c=`${t}/api/v1/extensions/langs/google_translate`,r={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({context:e,source_lang_number:o,target_lang_number:a}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:n}};fetch(c,r).then((e=>e.json())).then((e=>{s(e)})).catch((e=>{console.log(e),s(e)}))}))}(o,a,s);e.postMessage({data:c})}(e,o.keyword,o.sourceLangNumber,o.targetLangNumber);break;case"deeplTranslation":!async function(e,o,a,s){const c=await function(e,o,a){return new Promise((s=>{const c=`${t}/api/v1/extensions/langs/deepl_translate`,r={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({context:e,source_lang_number:o,target_lang_number:a}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:n}};fetch(c,r).then((e=>e.json())).then((e=>{s(e)})).catch((e=>{console.log(e),s(e)}))}))}(o,a,s);e.postMessage({data:c})}(e,o.keyword,o.sourceLangNumber,o.targetLangNumber);break;case"aiSearch":!async function(e,o,a,s,c,r){const i=await function(e,o,a,s,c){return new Promise((r=>{const i=`${t}/api/v1/extensions/langs/ai_search`,d={method:"POST",mode:"cors",credentials:"include",body:JSON.stringify({keyword:e,source_lang_number:o,target_lang_number:a,prompt_key:s,version:c}),dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8",authorization:n}};fetch(i,d).then((e=>e.json())).then((e=>{r(e)})).catch((e=>{r(e)}))}))}(o,a,s,c,r);e.postMessage({data:i})}(e,o.keyword,o.sourceLangNumber,o.targetLangNumber,o.promptKey,o.version)}}))})),chrome.runtime.onMessage.addListener(((e,t,n)=>{if("playAudio"===e.action)return async function(e,t=1){return await async function(){console.log("createOffscreen"),await chrome.offscreen.hasDocument()?console.log("Offscreen document already exists"):await chrome.offscreen.createDocument({url:"offscreen.html",reasons:["AUDIO_PLAYBACK"],justification:"testing"})}(),new Promise(((n,o)=>{chrome.runtime.sendMessage({play:{source:e,volume:t}},(e=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):n(e)}))}))}(e.url).then((e=>{n({success:!0,response:e})})).catch((e=>{n({success:!1,error:e.message})})),!0}))})();